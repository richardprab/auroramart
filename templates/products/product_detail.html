{% extends 'base.html' %}
{% load static %}

{% block title %}{{ product.name }} - AuroraMart{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Breadcrumb -->
    <nav class="text-sm mb-6 products-breadcrumb">
        <a href="{% url 'home:index' %}" class="text-blue-600 hover:underline">Home</a>
        <span class="mx-2">/</span>
        <a href="{% url 'products:product_list' %}" class="text-blue-600 hover:underline">Products</a>
        <span class="mx-2">/</span>
        <span class="text-gray-600">{{ product.name }}</span>
    </nav>

    <!-- Back Button -->
    <div class="mb-6">
        <a href="{% url 'products:product_list' %}" class="inline-flex items-center gap-2 text-blue-600 hover:text-blue-700 font-medium text-sm transition">
            <i data-lucide="arrow-left" class="w-4 h-4"></i>
            Back to Products
        </a>
    </div>

    {% with lowest_variant=product.get_lowest_priced_variant primary_image=product.images.first %}
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
        <!-- Product Images -->
        <div>
            <div class="bg-gray-100 rounded-lg mb-4 h-96 flex items-center justify-center">
                {% if primary_image %}
                <img src="{{ primary_image.image.url }}" alt="{{ product.name }}"
                    class="max-h-full max-w-full object-contain">
                {% else %}
                <svg xmlns="http://www.w3.org/2000/svg" class="w-32 h-32 text-gray-400" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2">
                    <path
                        d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z">
                    </path>
                </svg>
                {% endif %}
            </div>

            <!-- Thumbnail Gallery -->
            {% if product.images.count > 1 %}
            <div class="grid grid-cols-4 gap-2">
                {% for image in product.images.all %}
                <div
                    class="bg-gray-100 rounded-lg h-20 flex items-center justify-center cursor-pointer hover:ring-2 hover:ring-blue-500">
                    <img src="{{ image.image.url }}" alt="{{ product.name }}"
                        class="max-h-full max-w-full object-contain">
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- Product Info -->
        <div>
            <!-- Badges -->
            <div class="flex gap-2 mb-4">
                {% if product.is_trending %}
                <span class="bg-red-100 text-red-600 text-xs px-3 py-1 rounded-full font-semibold">üî• Trending</span>
                {% endif %}
                {% if product.is_bestseller %}
                <span class="bg-yellow-100 text-yellow-600 text-xs px-3 py-1 rounded-full font-semibold">‚≠ê Best
                    Seller</span>
                {% endif %}
            </div>

            <h1 class="text-3xl font-bold mb-4">{{ product.name }}</h1>

            <!-- Rating -->
            <div class="flex items-center mb-4">
                <div class="flex text-yellow-400">
                    {% with rating=product.rating|floatformat:0|add:0 %}
                    {% for i in "12345" %}
                    {% if forloop.counter <= rating %} <svg xmlns="http://www.w3.org/2000/svg"
                        class="w-5 h-5 fill-current" viewBox="0 0 24 24">
                        <path
                            d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                        </svg>
                        {% else %}
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <path
                                d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                        </svg>
                        {% endif %}
                        {% endfor %}
                        {% endwith %}
                </div>
                <span class="text-gray-600 ml-2">({{ product.review_count }} reviews)</span>
            </div>

            <!-- Price -->
            {% if lowest_variant %}
            <div class="mb-6" id="price-section">
                <div class="flex items-baseline gap-3">
                    <span class="text-4xl font-bold text-gray-900" id="current-price">${{ lowest_variant.price }}</span>
                    {% if lowest_variant.compare_price and lowest_variant.compare_price > lowest_variant.price %}
                    <span class="text-2xl text-gray-500 line-through" id="original-price">${{ lowest_variant.compare_price }}</span>
                    <span class="text-green-600 font-semibold" id="discount-badge">Save {{ lowest_variant.discount_percentage }}%</span>
                    {% endif %}
                </div>
            </div>

            <!-- Stock Status -->
            <div class="mb-6" id="stock-section">
                {% if lowest_variant.stock > 0 %}
                <span class="text-green-600 font-semibold flex items-center gap-2" id="stock-status">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                    In Stock
                </span>
                {% else %}
                <span class="text-red-600 font-semibold flex items-center gap-2" id="stock-status">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="15" y1="9" x2="9" y2="15"></line>
                        <line x1="9" y1="9" x2="15" y2="15"></line>
                    </svg>
                    Out of Stock
                </span>
                {% endif %}
            </div>
            {% endif %}

            <!-- Description -->
            <div class="mb-6">
                <h3 class="font-semibold text-lg mb-2">Description</h3>
                <p class="text-gray-700">{{ product.description }}</p>
            </div>

            <!-- Category -->
            <div class="mb-6">
                <span class="text-gray-600">Category: </span>
                <a href="{% url 'products:product_list' %}?category={{ product.category.slug }}"
                    class="text-blue-600 hover:underline">
                    {{ product.category.name }}
                </a>
            </div>

            <!-- Variant Selector (Fashion Items Only) -->
            {% if is_fashion_category and available_colors %}
            <div class="mb-6 space-y-4">
                <!-- Color Selector -->
                {% if available_colors %}
                <div>
                    <h3 class="font-semibold mb-3">Color</h3>
                    <div class="flex flex-wrap gap-2">
                        {% for color in available_colors %}
                        <button type="button" 
                            class="variant-color-btn px-4 py-2 border-2 rounded-lg transition hover:border-blue-600 focus:outline-none focus:border-blue-600"
                            data-color="{{ color }}">
                            {{ color }}
                        </button>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Size Selector -->
                {% if available_sizes %}
                <div>
                    <h3 class="font-semibold mb-3">Size</h3>
                    <div class="flex flex-wrap gap-2">
                        {% for size in available_sizes %}
                        <button type="button" 
                            class="variant-size-btn px-4 py-2 border-2 rounded-lg transition hover:border-blue-600 focus:outline-none focus:border-blue-600"
                            data-size="{{ size }}">
                            {{ size }}
                        </button>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Actions -->
            <div class="flex gap-4">
                {% if lowest_variant and lowest_variant.stock > 0 %}
                <form action="{% url 'cart:add_to_cart' product_id=product.id %}" method="post" class="flex-1 ajax-add-to-cart" id="add-to-cart-form">
                    {% csrf_token %}
                    <input type="hidden" name="variant_id" value="{{ lowest_variant.id }}" id="selected-variant-id">
                    <input type="hidden" name="quantity" value="1">
                    <button type="submit"
                        class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition flex items-center justify-center gap-2"
                        data-add-to-cart data-product-id="{{ product.id }}" id="add-to-cart-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <circle cx="9" cy="21" r="1"></circle>
                            <circle cx="20" cy="21" r="1"></circle>
                            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                        </svg>
                        Add to Cart
                    </button>
                </form>
                {% else %}
                <button disabled
                    class="flex-1 bg-gray-300 text-gray-600 px-6 py-3 rounded-lg font-semibold cursor-not-allowed" id="add-to-cart-btn">
                    Out of Stock
                </button>
                {% endif %}

                {% if user.is_authenticated %}
                <form action="{% url 'accounts:add_to_wishlist' product_id=product.id %}" method="post" data-wishlist-toggle>
                    {% csrf_token %}
                    <button type="submit" data-product-id="{{ product.id }}"
                        class="bg-gray-200 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-300 transition">
                        {% if is_in_wishlist %}
                        <i data-lucide="heart" class="w-6 h-6 text-red-500 fill-current"></i>
                        {% else %}
                        <i data-lucide="heart" class="w-6 h-6"></i>
                        {% endif %}
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>
    {% endwith %}

    <!-- Related Products -->
        {% if related_products %}
        <div>
            <h2 class="text-2xl font-bold mb-6">Related Products</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                {% for product in related_products %}
                {% include 'products/product_card.html' %}
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Variant Selection JavaScript -->
    {% if is_fashion_category %}
    <!-- Hidden variant data elements (rendered for templates but consumed by JS to avoid inline template tokens inside scripts) -->
    {% for variant in product.variants.all %}
    <div class="variant-data" style="display:none"
         data-id="{{ variant.id }}"
         data-color="{{ variant.color }}"
         data-size="{{ variant.size }}"
         data-price="{{ variant.price }}"
         data-compare-price="{% if variant.compare_price %}{{ variant.compare_price }}{% else %}0{% endif %}"
         data-stock="{{ variant.stock }}"
         data-sku="{{ variant.sku }}"></div>
    {% endfor %}

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Build variants array from DOM data-* attributes to avoid embedding template tags inside JS code
            const variants = Array.from(document.querySelectorAll('.variant-data')).map(el => ({
                id: Number(el.dataset.id),
                color: el.dataset.color || "",
                size: el.dataset.size || "",
                price: Number(el.dataset.price),
                comparePrice: Number(el.dataset.comparePrice) || null,
                stock: Number(el.dataset.stock),
                sku: el.dataset.sku || ""
            }));

            let selectedColor = null;
            let selectedSize = null;

            function updateAvailability() {
                // Reset all strikethrough styles
                document.querySelectorAll('.variant-size-btn').forEach(btn => {
                    btn.classList.remove('opacity-50', 'line-through', 'cursor-not-allowed', 'pointer-events-none');
                });

                // Update sizes based on selected color (strikethrough unavailable sizes)
                if (selectedColor) {
                    document.querySelectorAll('.variant-size-btn').forEach(btn => {
                        const size = btn.dataset.size;
                        const variant = variants.find(v => v.size === size && v.color === selectedColor);
                        
                        if (!variant || variant.stock === 0) {
                            btn.classList.add('opacity-50', 'line-through', 'cursor-not-allowed', 'pointer-events-none');
                        }
                    });
                }
            }

            // Color button handlers
            document.querySelectorAll('.variant-color-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const clickedColor = this.dataset.color;
                    
                    // Remove active class from all color buttons
                    document.querySelectorAll('.variant-color-btn').forEach(b => {
                        b.classList.remove('border-blue-600', 'bg-blue-50');
                    });
                    // Add active class to clicked button
                    this.classList.add('border-blue-600', 'bg-blue-50');
                    selectedColor = clickedColor;
                    
                    // Check if current size is available for this color
                    if (selectedSize) {
                        const variant = variants.find(v => v.color === clickedColor && v.size === selectedSize);
                        if (!variant || variant.stock === 0) {
                            // Current size not available, find first available size
                            const availableVariant = variants.find(v => v.color === clickedColor && v.stock > 0);
                            if (availableVariant) {
                                // Deselect current size
                                document.querySelectorAll('.variant-size-btn').forEach(b => {
                                    b.classList.remove('border-blue-600', 'bg-blue-50');
                                });
                                // Select the available size
                                const sizeBtn = document.querySelector(`.variant-size-btn[data-size="${availableVariant.size}"]`);
                                if (sizeBtn) {
                                    sizeBtn.classList.add('border-blue-600', 'bg-blue-50');
                                    selectedSize = availableVariant.size;
                                }
                            } else {
                                // No available sizes for this color, clear size selection
                                document.querySelectorAll('.variant-size-btn').forEach(b => {
                                    b.classList.remove('border-blue-600', 'bg-blue-50');
                                });
                                selectedSize = null;
                            }
                        }
                    }
                    
                    updateAvailability();
                    updateVariant();
                });
            });

            // Size button handlers
            document.querySelectorAll('.variant-size-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const clickedSize = this.dataset.size;
                    
                    // Remove active class from all size buttons
                    document.querySelectorAll('.variant-size-btn').forEach(b => {
                        b.classList.remove('border-blue-600', 'bg-blue-50');
                    });
                    // Add active class to clicked button
                    this.classList.add('border-blue-600', 'bg-blue-50');
                    selectedSize = clickedSize;
                    
                    updateAvailability();
                    updateVariant();
                });
            });

            function updateVariant() {
                // Check if both color and size are selected
                if (!selectedColor || !selectedSize) {
                    return;
                }

                // Find matching variant
                const matchingVariant = variants.find(v => 
                    v.color === selectedColor && v.size === selectedSize
                );

                if (!matchingVariant) {
                    return;
                }

                // Update price
                const currentPriceEl = document.getElementById('current-price');
                const originalPriceEl = document.getElementById('original-price');
                const discountBadgeEl = document.getElementById('discount-badge');
                const priceSection = document.getElementById('price-section').querySelector('div');

                currentPriceEl.textContent = '$' + matchingVariant.price.toFixed(2);

                // Handle compare price (discount)
                if (matchingVariant.comparePrice && matchingVariant.comparePrice > matchingVariant.price) {
                    const discountPercent = Math.round((1 - matchingVariant.price / matchingVariant.comparePrice) * 100);
                    
                    if (!originalPriceEl) {
                        // Create original price element if it doesn't exist
                        const originalPrice = document.createElement('span');
                        originalPrice.id = 'original-price';
                        originalPrice.className = 'text-2xl text-gray-500 line-through';
                        originalPrice.textContent = '$' + matchingVariant.comparePrice.toFixed(2);
                        priceSection.appendChild(originalPrice);

                        const discountBadge = document.createElement('span');
                        discountBadge.id = 'discount-badge';
                        discountBadge.className = 'text-green-600 font-semibold';
                        discountBadge.textContent = 'Save ' + discountPercent + '%';
                        priceSection.appendChild(discountBadge);
                    } else {
                        originalPriceEl.textContent = '$' + matchingVariant.comparePrice.toFixed(2);
                        discountBadgeEl.textContent = 'Save ' + discountPercent + '%';
                    }
                } else {
                    // Remove compare price if it exists
                    if (originalPriceEl) originalPriceEl.remove();
                    if (discountBadgeEl) discountBadgeEl.remove();
                }

                // Update stock
                const stockStatus = document.getElementById('stock-status');
                const addToCartBtn = document.getElementById('add-to-cart-btn');
                const variantIdInput = document.getElementById('selected-variant-id');

                if (matchingVariant.stock > 0) {
                    stockStatus.className = 'text-green-600 font-semibold flex items-center gap-2';
                    stockStatus.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                        In Stock
                    `;
                    addToCartBtn.disabled = false;
                    addToCartBtn.classList.remove('bg-gray-300', 'text-gray-600', 'cursor-not-allowed');
                    addToCartBtn.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700');
                    if (addToCartBtn.tagName === 'BUTTON' && addToCartBtn.type === 'submit') {
                        addToCartBtn.querySelector('svg').style.display = 'inline';
                        addToCartBtn.childNodes[addToCartBtn.childNodes.length - 1].textContent = ' Add to Cart';
                    }
                } else {
                    stockStatus.className = 'text-red-600 font-semibold flex items-center gap-2';
                    stockStatus.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="15" y1="9" x2="9" y2="15"></line>
                            <line x1="9" y1="9" x2="15" y2="15"></line>
                        </svg>
                        Out of Stock
                    `;
                    addToCartBtn.disabled = true;
                    addToCartBtn.classList.add('bg-gray-300', 'text-gray-600', 'cursor-not-allowed');
                    addToCartBtn.classList.remove('bg-blue-600', 'text-white', 'hover:bg-blue-700');
                    if (addToCartBtn.tagName === 'BUTTON') {
                        addToCartBtn.textContent = 'Out of Stock';
                    }
                }

                // Update variant ID in form
                variantIdInput.value = matchingVariant.id;
            }

            // Auto-select the variant that matches the displayed price on page load
            const displayedPrice = parseFloat(document.getElementById('current-price').textContent.replace('$', ''));
            const firstVariantMatch = variants.find(v => Math.abs(v.price - displayedPrice) < 0.01);
            
            if (firstVariantMatch) {
                // Find and click the color button
                const colorBtn = document.querySelector(`.variant-color-btn[data-color="${firstVariantMatch.color}"]`);
                if (colorBtn) {
                    colorBtn.classList.add('border-blue-600', 'bg-blue-50');
                    selectedColor = firstVariantMatch.color;
                }
                
                // Find and click the size button
                const sizeBtn = document.querySelector(`.variant-size-btn[data-size="${firstVariantMatch.size}"]`);
                if (sizeBtn) {
                    sizeBtn.classList.add('border-blue-600', 'bg-blue-50');
                    selectedSize = firstVariantMatch.size;
                }
                
                // Update availability after setting initial selection
                updateAvailability();
            }
        });
    </script>
    {% endif %}
    {% endblock %}