{% extends 'adminpanel/base.html' %}

{% block admin_title %}Edit Order{% endblock %}

{% block admin_extra_css %}
<style>
    .back-button {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.625rem 1.25rem;
        background: #3b82f6;
        color: white;
        text-decoration: none;
        border-radius: 0.5rem;
        margin-bottom: 1.25rem;
        transition: all 0.2s;
        font-weight: 500;
    }

    .back-button:hover {
        background: #2563eb;
        transform: translateX(-4px);
    }

    .order-section {
        background: white;
        padding: 1.5rem;
        border-radius: 0.625rem;
        margin-bottom: 1.25rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        border: 1px solid #e5e7eb;
    }

    .order-section h3 {
        font-size: 1.125rem;
        margin-bottom: 1.25rem;
        color: #1f2937;
        border-bottom: 2px solid #3b82f6;
        padding-bottom: 0.625rem;
        font-weight: 600;
    }

    .order-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.25rem;
    }

    .order-id {
        font-size: 1.5rem;
        font-weight: bold;
        color: #3b82f6;
    }

    .order-status-badge {
        padding: 0.5rem 1.25rem;
        border-radius: 1.25rem;
        font-size: 0.875rem;
        font-weight: 600;
        display: inline-block;
        text-align: center;
    }

    .status-pending {
        background: #fef3c7;
        color: #92400e;
    }

    .status-confirmed {
        background: #dbeafe;
        color: #1e40af;
    }

    .status-processing {
        background: #dbeafe;
        color: #1e40af;
    }

    .status-shipped {
        background: #ddd6fe;
        color: #5b21b6;
    }

    .status-delivered {
        background: #d1fae5;
        color: #065f46;
    }

    .status-cancelled {
        background: #fee2e2;
        color: #991b1b;
    }

    .status-refunded {
        background: #fee2e2;
        color: #991b1b;
    }

    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.25rem;
        margin-bottom: 1rem;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: #374151;
        font-weight: 500;
        font-size: 0.875rem;
    }

    .form-control {
        width: 100%;
        padding: 0.625rem 0.938rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-family: inherit;
        transition: all 0.2s;
    }

    .form-control:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-control:disabled {
        background: #f3f4f6;
        cursor: not-allowed;
    }

    select.form-control {
        cursor: pointer;
    }

    textarea.form-control {
        resize: vertical;
        min-height: 80px;
    }

    .order-items-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }

    .order-items-table th {
        background: #f9fafb;
        padding: 0.75rem;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #e5e7eb;
        font-size: 0.875rem;
    }

    .order-items-table td {
        padding: 0.75rem;
        border-bottom: 1px solid #f3f4f6;
        font-size: 0.875rem;
    }

    .tracking-info {
        background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        color: white;
        padding: 1.25rem;
        border-radius: 0.625rem;
    }

    .tracking-steps {
        display: flex;
        justify-content: space-between;
        margin-top: 1.25rem;
        position: relative;
    }

    .tracking-step {
        flex: 1;
        text-align: center;
        position: relative;
    }

    .tracking-step::before {
        content: '';
        position: absolute;
        top: 15px;
        left: 0;
        right: 0;
        height: 2px;
        background: rgba(255, 255, 255, 0.3);
        z-index: 0;
    }

    .tracking-step:first-child::before {
        left: 50%;
    }

    .tracking-step:last-child::before {
        right: 50%;
    }

    .tracking-dot {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        margin: 0 auto 0.625rem;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        z-index: 1;
    }

    .tracking-step.active .tracking-dot {
        background: white;
        color: #3b82f6;
        font-weight: bold;
    }

    .tracking-label {
        font-size: 0.75rem;
        opacity: 0.8;
    }

    .tracking-step.active .tracking-label {
        opacity: 1;
        font-weight: 600;
    }

    .btn-update {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 0.938rem 2.5rem;
        border: none;
        border-radius: 0.5rem;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        margin-top: 1.25rem;
    }

    .btn-update:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    .editable-notice {
        background: #fef3c7;
        color: #92400e;
        padding: 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.813rem;
        margin-bottom: 1rem;
    }

    .readonly-notice {
        background: #fee2e2;
        color: #991b1b;
        padding: 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.813rem;
        margin-bottom: 1rem;
    }

    .info-badge {
        display: inline-block;
        padding: 0.5rem 0.938rem;
        background: #f3f4f6;
        border-radius: 0.375rem;
        font-size: 0.813rem;
        color: #374151;
    }
</style>
{% endblock %}

{% block admin_content %}
<div class="admin-content-header">
    <h2>Edit Order</h2>
    <p>Update order details and tracking information</p>
</div>

<div class="admin-content-body">
    {% if search_query %}
    <a href="{% url 'adminpanel:order_management' %}?q={{ search_query|urlencode }}" class="back-button">
        <i data-lucide="arrow-left" class="w-4 h-4"></i>
        Back to Orders
    </a>
    {% else %}
    <a href="{% url 'adminpanel:order_management' %}" class="back-button">
        <i data-lucide="arrow-left" class="w-4 h-4"></i>
        Back to Orders
    </a>
    {% endif %}

    <div class="order-section">
        <div class="order-header">
            <div class="order-id">Order #{{ order.order_number }}</div>
            <div class="order-status-badge status-{{ order.status }}">
                {{ order.get_status_display }}
            </div>
        </div>

        <div class="form-row">
            <div class="info-badge"><i data-lucide="user" class="w-4 h-4 inline"></i> Customer: {{ order.user.username|upper }}</div>
            <div class="info-badge"><i data-lucide="calendar" class="w-4 h-4 inline"></i> Date: {{ order.created_at|date:"M d, Y" }}</div>
            {% if order.expected_delivery_date %}
            <div class="info-badge"><i data-lucide="truck" class="w-4 h-4 inline"></i> Expected: {{ order.expected_delivery_date|date:"M d, Y" }}</div>
            {% endif %}
        </div>
    </div>

    <form method="post" action="{% url 'adminpanel:update_order' order.id %}" id="orderUpdateForm">
        {% csrf_token %}
        <input type="hidden" name="search_query" value="{{ search_query }}">

        <!-- Tracking Information -->
        <div class="order-section">
            <h3><i data-lucide="map-pin" class="w-5 h-5 inline"></i> Order Tracking</h3>
            <div class="tracking-info">
                <div class="form-group">
                    <label style="color: white;">Current Location:</label>
                    <select name="current_location" class="form-control">
                        {% for value, label in location_choices %}
                        <option value="{{ value }}" {% if order.current_location == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="tracking-steps">
                    {% for value, label in location_choices %}
                    <div class="tracking-step {% if order.current_location == value %}active{% endif %}">
                        <div class="tracking-dot">
                            {% if order.current_location == value %}âœ“{% endif %}
                        </div>
                        <div class="tracking-label">{{ label|truncatewords:2 }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Order Status -->
        <div class="order-section">
            <h3><i data-lucide="clipboard-check" class="w-5 h-5 inline"></i> Order Status</h3>
            <div class="form-group">
                <label>Status:</label>
                <select name="status" class="form-control">
                    {% for value, label in status_choices %}
                    <option value="{{ value }}" {% if order.status == value %}selected{% endif %}>
                        {{ label }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Contact & Delivery Information -->
        <div class="order-section">
            <h3><i data-lucide="phone" class="w-5 h-5 inline"></i> Contact & Delivery Information</h3>
            
            {% if order.status in 'pending,confirmed,processing' %}
            <div class="editable-notice">
                <i data-lucide="edit" class="w-4 h-4 inline"></i> This order is editable. You can modify contact number and delivery address.
            </div>
            {% else %}
            <div class="readonly-notice">
                <i data-lucide="lock" class="w-4 h-4 inline"></i> This order cannot be edited (Status: {{ order.get_status_display }})
            </div>
            {% endif %}

            <div class="form-row">
                <div class="form-group">
                    <label>Contact Number:</label>
                    <input 
                        type="text" 
                        name="contact_number" 
                        class="form-control" 
                        value="{{ order.contact_number }}"
                        {% if order.status not in 'pending,confirmed,processing' %}disabled{% endif %}
                    >
                </div>
            </div>

            <div class="form-group">
                <label>Delivery Address:</label>
                <textarea 
                    name="delivery_address" 
                    class="form-control"
                    {% if order.status not in 'pending,confirmed,processing' %}disabled{% endif %}
                >{{ order.delivery_address }}</textarea>
            </div>
        </div>

        <!-- Order Items -->
        <div class="order-section">
            <h3><i data-lucide="package" class="w-5 h-5 inline"></i> Order Items</h3>
            <table class="order-items-table">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Variant</th>
                        <th>Quantity</th>
                        <th>Price</th>
                        <th>Subtotal</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in order.items.all %}
                    <tr>
                        <td>
                            {% if item.variant and item.variant.product %}
                                {{ item.variant.product.name }}
                            {% elif item.product %}
                                {{ item.product.name }}
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td>
                            {% if item.variant %}
                                <strong>ID:</strong> {{ item.variant.id }} | 
                                <strong>SKU:</strong> {{ item.variant.sku }} | 
                                <strong>Price:</strong> ${{ item.variant.price }}
                            {% elif item.product_variant %}
                                <strong>ID:</strong> {{ item.product_variant.id }} | 
                                <strong>SKU:</strong> {{ item.product_variant.sku }} | 
                                <strong>Price:</strong> ${{ item.product_variant.price }}
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td>{{ item.quantity }}</td>
                        <td>${{ item.price }}</td>
                        <td>${{ item.subtotal }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="border-t-2 border-blue-600 bg-gray-50 font-bold">
                        <td colspan="4" class="text-right pr-4">Order Total:</td>
                        <td class="text-lg text-blue-600">${{ order.total }}</td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <button type="submit" class="btn-update">
            <i data-lucide="save" class="w-4 h-4 inline"></i> Update Order
        </button>
    </form>
</div>

<script>
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
</script>
{% endblock %}
