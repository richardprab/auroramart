{% extends 'adminpanel/base.html' %}

{% block title %}Product Management{% endblock %}

{% block extra_css %}
<style>
    .search-section {
        margin-bottom: 30px;
    }

    .search-form {
        display: flex;
        gap: 10px;
    }

    .search-input {
        flex: 1;
        padding: 12px 20px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 15px;
    }

    .search-input:focus {
        outline: none;
        border-color: #667eea;
    }

    .btn-search {
        padding: 12px 30px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-search:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .product-editor {
        background: #f8f9fa;
        padding: 30px;
        border-radius: 12px;
        margin-top: 20px;
        display: none;
    }

    .product-editor.active {
        display: block;
    }

    .product-section {
        background: white;
        padding: 25px;
        border-radius: 10px;
        margin-bottom: 20px;
    }

    .product-section h3 {
        font-size: 18px;
        margin-bottom: 20px;
        color: #333;
        border-bottom: 2px solid #667eea;
        padding-bottom: 10px;
    }

    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 15px;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #555;
        font-weight: 500;
        font-size: 14px;
    }

    .form-control {
        width: 100%;
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        font-family: inherit;
    }

    .form-control:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    textarea.form-control {
        resize: vertical;
        min-height: 100px;
    }

    .image-preview {
        width: 100%;
        max-width: 300px;
        height: 200px;
        object-fit: cover;
        border-radius: 8px;
        margin-top: 10px;
        border: 2px solid #e0e0e0;
    }

    .variants-container {
        margin-top: 20px;
    }

    .variant-item {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 15px;
        border-left: 4px solid #667eea;
    }

    .variant-header {
        font-weight: 600;
        margin-bottom: 15px;
        color: #333;
    }

    .btn-update {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        padding: 15px 40px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        margin-top: 20px;
    }

    .btn-update:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: #999;
    }

    .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
    }

    .success-message {
        background: #d4edda;
        color: #155724;
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
    }

    .file-input-wrapper {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .file-input-wrapper input[type="text"] {
        flex: 1;
    }

    .file-input-wrapper input[type="file"] {
        flex: 1;
    }

    .or-divider {
        text-align: center;
        color: #999;
        margin: 10px 0;
        font-size: 13px;
    }

    /* Add these to the existing <style> block in extra_css: */

    .order-detail {
        background: #f8f9fa;
        padding: 30px;
        border-radius: 12px;
        margin-top: 20px;
    }

    .order-section h3 {
        font-size: 20px;
        margin-bottom: 20px;
        color: #333;
        border-bottom: 2px solid #667eea;  /* THIS LINE CREATES THE BLUE UNDERLINE */
        padding-bottom: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="content-header">
    <h2>Product Management</h2>
    <p>Search and edit product details</p>
</div>

<div class="content-body">
    <div class="search-section">
        <form class="search-form" id="productSearchForm">
            <input 
                type="text" 
                name="search" 
                class="search-input" 
                placeholder="Enter product code (e.g., PHO-0001, phones-product-1)..."
                id="searchInput"
                value="{{ request.GET.search }}"
            >
            <button type="submit" class="btn-search">üîç Search</button>
        </form>
    </div>

    <!-- ADD THIS SECTION -->
    {% if not request.GET.search %}
    <!-- Search Instructions -->
    <div class="order-detail">
        <div class="order-section" style="text-align: center; padding: 60px 20px;">
            <div style="font-size: 60px; margin-bottom: 20px;">üîç</div>
            <h3 style="color: #333;">Search for Products</h3>
            <p style="color: #666;">Enter a Product Code (e.g., PHO-0001) or Product Name (e.g., phones-product-1) to get started</p>
        </div>
    </div>
    {% endif %}
    <!-- END OF NEW SECTION -->

    <div id="productEditor" class="product-editor">
        <div class="loading">Searching...</div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.getElementById('productSearchForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const query = document.getElementById('searchInput').value.trim();
    
    if (!query) {
        alert('Please enter a product code');
        return;
    }

    const editor = document.getElementById('productEditor');
    editor.classList.add('active');
    editor.innerHTML = '<div class="loading">üîç Searching for product...</div>';

    fetch(`{% url 'adminpanel:search_product' %}?query=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            if (data.products && data.products.length > 0) {
                displayProduct(data.products[0]);
            } else {
                editor.innerHTML = '<div class="error-message">‚ùå No product found with that code</div>';
            }
        })
        .catch(error => {
            editor.innerHTML = '<div class="error-message">‚ùå Error searching product</div>';
            console.error('Error:', error);
        });
});

function displayProduct(product) {
    const editor = document.getElementById('productEditor');
    
    let variantsHTML = '';
    product.variants.forEach((variant, index) => {
        const variantImageUrl = variant.images.length > 0 ? variant.images[0].url : '';
        
        variantsHTML += `
            <div class="variant-item">
                <div class="variant-header">Variant: ${variant.name}</div>
                <input type="hidden" name="variant_id[]" value="${variant.id}">
                <div class="form-row">
                    <div class="form-group">
                        <label>Variant Name:</label>
                        <input type="text" class="form-control" name="variant_name_${index}" value="${variant.name}">
                    </div>
                    <div class="form-group">
                        <label>SKU:</label>
                        <input type="text" class="form-control" value="${variant.sku}" readonly>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Stock:</label>
                        <input type="number" class="form-control" name="variant_stock_${index}" value="${variant.stock}" min="0">
                    </div>
                    <div class="form-group">
                        <label>Price ($):</label>
                        <input type="number" class="form-control" name="variant_price_${index}" value="${variant.price}" step="0.01" min="0">
                    </div>
                </div>
                <div class="form-group">
                    <label>Variant Image URL:</label>
                    <input type="text" class="form-control" name="variant_image_url_${index}" 
                           value="${variantImageUrl}" 
                           placeholder="https://example.com/image.jpg"
                           onchange="previewImage(this, 'variantPreview${index}')">
                    <div class="or-divider">OR</div>
                    <label>Upload Image:</label>
                    <input type="file" class="form-control" name="variant_image_file_${index}" accept="image/*">
                    ${variantImageUrl ? `<img src="${variantImageUrl}" class="image-preview" id="variantPreview${index}">` : ''}
                </div>
            </div>
        `;
    });

    const mainImageUrl = product.images.find(img => img.is_primary)?.url || '';

    editor.innerHTML = `
        <form id="updateProductForm">
            <input type="hidden" name="product_id" value="${product.id}">
            
            <div class="product-section">
                <h3>üì¶ Product Information</h3>
                <div class="form-group">
                    <label>Product Code:</label>
                    <input type="text" class="form-control" value="${product.slug}" readonly>
                </div>
                <div class="form-group">
                    <label>Product Name:</label>
                    <input type="text" class="form-control" name="name" value="${product.name}" required>
                </div>
                <div class="form-group">
                    <label>Category:</label>
                    <input type="text" class="form-control" name="category" value="${product.category || ''}" required>
                    <input type="hidden" name="category_id" value="${product.category_id || ''}">
                </div>
                <div class="form-group">
                    <label>Description:</label>
                    <textarea class="form-control" name="description" required>${product.description}</textarea>
                </div>
                <div class="form-group">
                    <label>Product Image URL:</label>
                    <input type="text" class="form-control" name="product_image_url" 
                           value="${mainImageUrl}" 
                           placeholder="https://example.com/image.jpg"
                           onchange="previewImage(this, 'productPreview')">
                    <div class="or-divider">OR</div>
                    <label>Upload Image:</label>
                    <input type="file" class="form-control" name="product_image_file" accept="image/*">
                    ${mainImageUrl ? `<img src="${mainImageUrl}" class="image-preview" id="productPreview">` : ''}
                </div>
            </div>

            <div class="product-section">
                <h3>üé® Product Variants</h3>
                <div class="variants-container">
                    ${variantsHTML || '<p>No variants available</p>'}
                </div>
            </div>

            <button type="submit" class="btn-update">üíæ Update Product</button>
        </form>
        <div id="updateMessage"></div>
    `;

    document.getElementById('updateProductForm').addEventListener('submit', handleProductUpdate);
}

function previewImage(input, previewId) {
    const preview = document.getElementById(previewId);
    if (input.value && input.value.startsWith('http')) {
        if (preview) {
            preview.src = input.value;
        } else {
            const img = document.createElement('img');
            img.src = input.value;
            img.className = 'image-preview';
            img.id = previewId;
            input.parentElement.appendChild(img);
        }
    }
}

function handleProductUpdate(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const messageDiv = document.getElementById('updateMessage');
    
    messageDiv.innerHTML = '<div class="loading">‚è≥ Updating product...</div>';

    fetch(`{% url 'adminpanel:update_product' %}`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            messageDiv.innerHTML = '<div class="success-message">‚úÖ Product updated successfully!</div>';
            setTimeout(() => {
                messageDiv.innerHTML = '';
            }, 3000);
        } else {
            messageDiv.innerHTML = `<div class="error-message">‚ùå Error: ${data.error}</div>`;
        }
    })
    .catch(error => {
        messageDiv.innerHTML = '<div class="error-message">‚ùå Error updating product</div>';
        console.error('Error:', error);
    });
}

// Auto-search if there's a query parameter
const hasSearchParam = '{{ request.GET.search|default:"" }}';
if (hasSearchParam) {
    window.addEventListener('load', function() {
        document.getElementById('productSearchForm').dispatchEvent(new Event('submit'));
    });
}
</script>
{% endblock %}