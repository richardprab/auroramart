{% extends 'base.html' %}
{% load static %}

{% block title %}Checkout - AuroraMart{% endblock %}

{% block content %}
<div class="bg-gray-50 min-h-screen py-8">
    <div class="container mx-auto px-4">
        <!-- Back to Cart Button -->
        <div class="mb-4">
            <a href="{% url 'cart:cart_detail' %}" 
               class="inline-flex items-center gap-2 text-blue-600 hover:text-blue-700 font-medium transition">
                <i data-lucide="arrow-left" class="w-4 h-4"></i>
                Back to Cart
            </a>
        </div>

        <!-- Progress Steps -->
        <div class="mb-8">
            <div class="flex items-center justify-center">
                <div class="flex items-center">
                    <div class="flex items-center text-green-600">
                        <div class="rounded-full h-10 w-10 flex items-center justify-center bg-green-600 text-white font-semibold">
                            <i data-lucide="check" class="w-6 h-6"></i>
                        </div>
                        <span class="ml-2 font-semibold">Cart</span>
                    </div>
                    <div class="w-24 h-1 bg-blue-600 mx-4"></div>
                    <div class="flex items-center text-blue-600">
                        <div class="rounded-full h-10 w-10 flex items-center justify-center bg-blue-600 text-white font-semibold">2</div>
                        <span class="ml-2 font-semibold">Checkout</span>
                    </div>
                    <div class="w-24 h-1 bg-gray-300 mx-4"></div>
                    <div class="flex items-center text-gray-400">
                        <div class="rounded-full h-10 w-10 flex items-center justify-center bg-gray-300 text-gray-600 font-semibold">3</div>
                        <span class="ml-2">Complete</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 backdrop-blur-sm">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 transform transition-all scale-95 opacity-0" id="modalContent">
                <div class="p-6">
                    <div class="flex items-center justify-center w-16 h-16 mx-auto bg-blue-100 rounded-full mb-4">
                        <i data-lucide="shopping-cart" class="w-8 h-8 text-blue-600"></i>
                    </div>
                    <h3 class="text-xl font-bold text-center text-gray-900 mb-2">Confirm Your Order</h3>
                    <p class="text-center text-gray-600 mb-6">Are you sure you want to place this order?</p>
                    
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <div class="flex justify-between text-sm mb-2">
                            <span class="text-gray-600">Order Total:</span>
                            <span class="font-bold text-gray-900">${{ total|floatformat:2 }}</span>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500">
                            <span>Payment Method:</span>
                            <span id="selectedPaymentMethod">Credit Card</span>
                        </div>
                    </div>
                    
                    <div class="flex gap-3">
                        <button type="button" 
                                id="cancelButton"
                                class="flex-1 px-4 py-3 border border-gray-300 rounded-lg text-gray-700 font-semibold hover:bg-gray-50 transition">
                            Cancel
                        </button>
                        <button type="button" 
                                id="confirmButton"
                                class="flex-1 px-4 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition flex items-center justify-center gap-2">
                            <i data-lucide="check" class="w-4 h-4"></i>
                            Confirm Order
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="bg-gray-50 min-h-screen py-6">
            <div class="container mx-auto px-4">
                <form method="post" action="{% url 'orders:process_checkout' %}" id="checkoutForm">
                    {% csrf_token %}
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Left Column - Checkout Form (2 columns) -->
                        <div class="lg:col-span-2 space-y-5">
                            
                            <!-- Contact Information -->
                            <div class="bg-white rounded-lg shadow-sm p-6">
                                <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                                    <i data-lucide="user" class="w-5 h-5 mr-2 text-blue-600"></i>
                                    Contact Information
                                </h2>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                                        <input type="text" id="full_name" name="full_name" 
                                               value="{% if user.first_name or user.last_name %}{{ user.first_name|default:'' }} {{ user.last_name|default:'' }}{% else %}{{ user.username }}{% endif %}"
                                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                               required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                        <input type="email" id="email" name="email" 
                                               value="{{ user.email }}"
                                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                               required>
                                    </div>
                                </div>
                            </div>

                            <!-- Shipping Address -->
                            <div class="bg-white rounded-lg shadow-sm p-6">
                                <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                                    <i data-lucide="map-pin" class="w-5 h-5 mr-2 text-blue-600"></i>
                                    Shipping Address
                                </h2>
                                
                                <!-- Saved Addresses Selection -->
                                {% if saved_addresses %}
                                <div class="mb-4">
                                    <!-- Default Address Display (shown by default) -->
                                    {% if default_address %}
                                    <div id="defaultAddressDisplay" class="mb-4">
                                        <div class="flex items-start justify-between p-3 border-2 border-blue-300 rounded-lg bg-blue-50">
                                            <div class="flex items-start flex-1">
                                                <input type="radio" name="selected_address" value="{{ default_address.id }}" 
                                                       class="mt-1 mr-3 address-radio" 
                                                       checked="checked">
                                                <div class="flex-1">
                                                    <span class="inline-block px-2 py-1 text-xs font-semibold bg-blue-600 text-white rounded mb-2">Default</span>
                                                    <div class="text-sm text-gray-700">
                                                        <div>{{ default_address.address_line1 }}</div>
                                                        {% if default_address.address_line2 %}
                                                        <div>{{ default_address.address_line2 }}</div>
                                                        {% endif %}
                                                        <div>{{ default_address.city }}, {{ default_address.state }} {{ default_address.postal_code }}</div>
                                                        <div>{{ default_address.country }}</div>
                                                    </div>
                                                </div>
                                            </div>
                                            <button type="button" onclick="showAllAddresses()" class="text-sm text-blue-600 hover:text-blue-700 font-medium cursor-pointer transition-colors duration-200 ml-4" style="background: transparent; border: none; padding: 0; white-space: nowrap;">
                                                Change
                                            </button>
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- All Addresses Selection (hidden by default, shown when "Change" is clicked) -->
                                    <div id="allAddressesSelection" style="display: none;" class="mb-4">
                                        <div class="space-y-2 mb-4" id="savedAddressesList">
                                            {% for address in saved_addresses %}
                                            <label class="flex items-start p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-blue-500 transition address-option" style="pointer-events: auto;">
                                                <input type="radio" name="selected_address" value="{{ address.id }}" 
                                                       class="mt-1 mr-3 address-radio" 
                                                       {% if address.is_default %}checked{% endif %}>
                                                <div class="flex-1">
                                                    {% if address.is_default %}
                                                    <span class="inline-block px-2 py-1 text-xs font-semibold bg-blue-600 text-white rounded mb-1">Default</span>
                                                    {% endif %}
                                                    <div class="text-sm text-gray-700">
                                                        <div>{{ address.address_line1 }}</div>
                                                        {% if address.address_line2 %}
                                                        <div>{{ address.address_line2 }}</div>
                                                        {% endif %}
                                                        <div>{{ address.city }}, {{ address.state }} {{ address.postal_code }}</div>
                                                        <div>{{ address.country }}</div>
                                                    </div>
                                                </div>
                                            </label>
                                            {% endfor %}
                                        </div>
                                        <button type="button" id="useNewAddressBtn" class="text-sm text-blue-600 hover:text-blue-700 font-medium cursor-pointer transition-colors duration-200" style="pointer-events: auto; z-index: 10; position: relative; background: transparent; border: none; padding: 0;">
                                            + Use a new address
                                        </button>
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- Address Form (shown by default if no saved addresses, or when "Use new address" is clicked) -->
                                <div class="space-y-4" id="addressFormSection" {% if saved_addresses %}style="display: none;"{% endif %}>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Street Address *</label>
                                        <input type="text" id="street_address" name="street_address"
                                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                               placeholder="123 Main Street, Apt 4B"
                                               required>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">City *</label>
                                            <input type="text" id="city" name="city"
                                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                   placeholder="Singapore"
                                                   required>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Postal Code *</label>
                                            <input type="text" id="postal_code" name="postal_code"
                                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                   placeholder="10001"
                                                   required>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Country *</label>
                                        <select id="country" name="country"
                                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                required>
                                            <option value="">Select Country</option>
                                            <option value="Singapore">Singapore</option>
                                            <option value="Malaysia">Malaysia</option>
                                            <option value="Thailand">Thailand</option>
                                            <option value="Indonesia">Indonesia</option>
                                            <option value="Philippines">Philippines</option>
                                            <option value="Vietnam">Vietnam</option>
                                            <option value="United States">United States</option>
                                            <option value="United Kingdom">United Kingdom</option>
                                            <option value="Australia">Australia</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Phone and Delivery Notes (always visible) -->
                                <div class="space-y-4 mt-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number *</label>
                                        <input type="tel" id="phone" name="phone"
                                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                               placeholder="+65 1234 5678"
                                               required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Delivery Notes (Optional)</label>
                                        <textarea id="delivery_notes" name="delivery_notes"
                                                  rows="3"
                                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                  placeholder="Any special instructions for delivery..."></textarea>
                                    </div>
                                </div>
                                {% if saved_addresses %}
                                <div id="backToSavedAddresses" style="display: none;" class="mt-4">
                                    <button type="button" onclick="showSavedAddresses()" class="text-sm text-blue-600 hover:text-blue-700 font-medium">
                                        ‚Üê Back to saved addresses
                                    </button>
                                </div>
                                {% endif %}
                            </div>

                            <!-- Billing Address -->
                            <div class="bg-white rounded-lg shadow-sm p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h2 class="text-xl font-bold text-gray-900 flex items-center">
                                        <i data-lucide="credit-card" class="w-5 h-5 mr-2 text-blue-600"></i>
                                        Billing Address
                                    </h2>
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="sameAsShipping" checked
                                               class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                        <span class="ml-2 text-sm text-gray-700">Same as shipping</span>
                                    </label>
                                </div>
                                
                                <div id="billingAddressSection" class="hidden space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Street Address</label>
                                        <input type="text" id="billing_street" name="billing_street"
                                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                               placeholder="123 Main Street, Apt 4B">
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">City</label>
                                            <input type="text" id="billing_city" name="billing_city"
                                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                   placeholder="New York">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Postal Code</label>
                                            <input type="text" id="billing_postal" name="billing_postal"
                                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                   placeholder="10001">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Country</label>
                                        <select id="billing_country" name="billing_country"
                                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            <option value="">Select Country</option>
                                            <option value="Singapore">Singapore</option>
                                            <option value="Malaysia">Malaysia</option>
                                            <option value="Thailand">Thailand</option>
                                            <option value="Indonesia">Indonesia</option>
                                            <option value="Philippines">Philippines</option>
                                            <option value="Vietnam">Vietnam</option>
                                            <option value="United States">United States</option>
                                            <option value="United Kingdom">United Kingdom</option>
                                            <option value="Australia">Australia</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Payment Method -->
                            <div class="bg-white rounded-lg shadow-sm p-6">
                                <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                                    <i data-lucide="wallet" class="w-5 h-5 mr-2 text-blue-600"></i>
                                    Payment Method
                                </h2>
                                <div class="space-y-3">
                                    <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-blue-500 transition">
                                        <input type="radio" name="payment_method" value="credit_card" checked
                                               class="payment-radio w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                        <div class="ml-3 flex items-center">
                                            <i data-lucide="credit-card" class="w-5 h-5 text-gray-600 mr-2"></i>
                                            <span class="text-sm font-medium text-gray-900">Credit/Debit Card</span>
                                        </div>
                                    </label>
                                    <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-blue-500 transition">
                                        <input type="radio" name="payment_method" value="paypal"
                                               class="payment-radio w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                        <div class="ml-3 flex items-center">
                                            <i data-lucide="smartphone" class="w-5 h-5 text-gray-600 mr-2"></i>
                                            <span class="text-sm font-medium text-gray-900">PayPal</span>
                                        </div>
                                    </label>
                                    <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-blue-500 transition">
                                        <input type="radio" name="payment_method" value="bank_transfer"
                                               class="payment-radio w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                        <div class="ml-3 flex items-center">
                                            <i data-lucide="building" class="w-5 h-5 text-gray-600 mr-2"></i>
                                            <span class="text-sm font-medium text-gray-900">Bank Transfer</span>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column - Order Summary (1 column) -->
                        <div class="lg:col-span-1">
                            <div id="orderSummary" class="bg-white rounded-lg shadow-sm p-6 sticky top-4 transition-transform duration-300">
                                <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                                    <i data-lucide="shopping-bag" class="w-5 h-5 mr-2 text-blue-600"></i>
                                    Order Summary
                                </h2>
                                
                                <!-- Cart Items -->
                                <div class="space-y-4 mb-4 max-h-64 overflow-y-auto">
                                    {% for item in cart_items %}
                                    <div class="flex items-start space-x-3 pb-3 border-b border-gray-100">
                                        {% if item.product.images.first %}
                                        <img src="{{ item.product.images.first.image.url }}" 
                                             alt="{{ item.product.name }}"
                                             class="w-16 h-16 object-cover rounded-lg">
                                        {% else %}
                                        <div class="w-16 h-16 bg-gray-200 rounded-lg flex items-center justify-center">
                                            <i data-lucide="image" class="w-6 h-6 text-gray-400"></i>
                                        </div>
                                        {% endif %}
                                        <div class="flex-1 min-w-0">
                                            <h3 class="text-sm font-medium text-gray-900 truncate">{{ item.product.name }}</h3>
                                            {% if item.product_variant %}
                                            <p class="text-xs text-gray-500">{{ item.product_variant.name }}</p>
                                            {% endif %}
                                            <p class="text-sm text-gray-600">Qty: {{ item.quantity }}</p>
                                        </div>
                                        <div class="text-sm font-medium text-gray-900">
                                            ${% if item.product_variant %}{{ item.product_variant.price|floatformat:2 }}{% else %}{{ item.product.price|floatformat:2 }}{% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>

                                <!-- Price Breakdown -->
                                <div class="space-y-2 py-4 border-t border-gray-200">
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-600">Subtotal</span>
                                        <span class="text-gray-900">${{ subtotal|floatformat:2 }}</span>
                                    </div>
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-600">Tax (10%)</span>
                                        <span class="text-gray-900">${{ tax|floatformat:2 }}</span>
                                    </div>
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-600">Shipping</span>
                                        <span class="text-gray-900">${{ shipping|floatformat:2 }}</span>
                                    </div>
                                    <div class="flex justify-between text-lg font-bold pt-2 border-t border-gray-200">
                                        <span class="text-gray-900">Total</span>
                                        <span class="text-blue-600">${{ total|floatformat:2 }}</span>
                                    </div>
                                </div>

                                <!-- Place Order Button -->
                                <button type="button" id="submitButton"
                                        class="place-order-btn w-full text-white py-3 px-6 rounded-lg font-bold flex items-center justify-center gap-2 mt-4">
                                    <i data-lucide="lock" class="w-4 h-4"></i>
                                    <span id="buttonText">Place Order</span>
                                </button>
                                
                                <p class="text-xs text-gray-500 text-center mt-3">
                                    <i data-lucide="shield-check" class="w-3 h-3 inline"></i>
                                    Your payment information is secure
                                </p>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <style>
        @keyframes modalSlideIn {
            from {
                transform: scale(0.95) translateY(-20px);
                opacity: 0;
            }
            to {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        .modal-show {
            display: flex !important;
        }

        .modal-show #modalContent {
            animation: modalSlideIn 0.3s ease-out forwards;
        }

        .summary-compact {
            transform: scale(0.95);
        }

        .place-order-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            border-radius: 0.625rem;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            position: relative;
            overflow: hidden;
        }

        .place-order-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .place-order-btn:hover::before {
            left: 100%;
        }

        .place-order-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        .place-order-btn:active {
            transform: translateY(0);
        }
        </style>

        <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // Ensure default address radio button is checked on page load
            const defaultAddressDisplay = document.getElementById('defaultAddressDisplay');
            if (defaultAddressDisplay) {
                const defaultRadio = defaultAddressDisplay.querySelector('.address-radio');
                if (defaultRadio) {
                    defaultRadio.checked = true;
                    // Uncheck any other address radios to ensure only default is selected
                    document.querySelectorAll('.address-radio').forEach(radio => {
                        if (radio !== defaultRadio) {
                            radio.checked = false;
                        }
                    });
                }
            }

            // Toggle billing address section
            const sameAsShippingCheckbox = document.getElementById('sameAsShipping');
            const billingAddressSection = document.getElementById('billingAddressSection');

            if (sameAsShippingCheckbox && billingAddressSection) {
                sameAsShippingCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        billingAddressSection.classList.add('hidden');
                    } else {
                        billingAddressSection.classList.remove('hidden');
                    }
                });
            }

            // Show all addresses when "Change" is clicked
            window.showAllAddresses = function() {
                const defaultAddressDisplay = document.getElementById('defaultAddressDisplay');
                const allAddressesSelection = document.getElementById('allAddressesSelection');
                
                if (defaultAddressDisplay) {
                    defaultAddressDisplay.style.display = 'none';
                }
                if (allAddressesSelection) {
                    allAddressesSelection.style.display = 'block';
                    allAddressesSelection.style.animation = 'fadeIn 0.3s ease-out';
                }
            };

            // Address selection functions
            window.showNewAddressForm = function() {
                console.log('showNewAddressForm called');
                const addressFormSection = document.getElementById('addressFormSection');
                const allAddressesSelection = document.getElementById('allAddressesSelection');
                const backToSavedAddresses = document.getElementById('backToSavedAddresses');
                
                if (addressFormSection) {
                    addressFormSection.style.display = 'block';
                    addressFormSection.style.animation = 'fadeIn 0.3s ease-out';
                }
                if (allAddressesSelection) {
                    allAddressesSelection.style.display = 'none';
                }
                if (backToSavedAddresses) {
                    backToSavedAddresses.style.display = 'block';
                }
                
                // Uncheck all address radios
                document.querySelectorAll('.address-radio').forEach(radio => radio.checked = false);
                
                // Make form fields required
                const streetAddress = document.getElementById('street_address');
                const city = document.getElementById('city');
                const postalCode = document.getElementById('postal_code');
                const country = document.getElementById('country');
                const phone = document.getElementById('phone');
                
                if (streetAddress) streetAddress.required = true;
                if (city) city.required = true;
                if (postalCode) postalCode.required = true;
                if (country) country.required = true;
                if (phone) phone.required = true;
            };

            window.showSavedAddresses = function() {
                console.log('showSavedAddresses called');
                const addressFormSection = document.getElementById('addressFormSection');
                const defaultAddressDisplay = document.getElementById('defaultAddressDisplay');
                const allAddressesSelection = document.getElementById('allAddressesSelection');
                const backToSavedAddresses = document.getElementById('backToSavedAddresses');
                
                if (addressFormSection) {
                    addressFormSection.style.display = 'none';
                }
                if (backToSavedAddresses) {
                    backToSavedAddresses.style.display = 'none';
                }
                
                // Show default address if it exists, otherwise show all addresses
                if (defaultAddressDisplay) {
                    defaultAddressDisplay.style.display = 'block';
                    defaultAddressDisplay.style.animation = 'fadeIn 0.3s ease-out';
                }
                if (allAddressesSelection) {
                    allAddressesSelection.style.display = 'none';
                }
                
                // Make form fields not required when using saved address
                const streetAddress = document.getElementById('street_address');
                const city = document.getElementById('city');
                const postalCode = document.getElementById('postal_code');
                const country = document.getElementById('country');
                const phone = document.getElementById('phone');
                
                if (streetAddress) streetAddress.required = false;
                if (city) city.required = false;
                if (postalCode) postalCode.required = false;
                if (country) country.required = false;
                if (phone) phone.required = true;
            };

            // Handle saved address selection
            document.querySelectorAll('.address-radio').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.checked) {
                        // Hide new address form
                        const addressFormSection = document.getElementById('addressFormSection');
                        const backToSavedAddresses = document.getElementById('backToSavedAddresses');
                        const allAddressesSelection = document.getElementById('allAddressesSelection');
                        const defaultAddressDisplay = document.getElementById('defaultAddressDisplay');
                        
                        if (addressFormSection) {
                            addressFormSection.style.display = 'none';
                        }
                        if (backToSavedAddresses) {
                            backToSavedAddresses.style.display = 'none';
                        }
                        
                        // If a saved address is selected, show default address display and hide all addresses selection
                        if (defaultAddressDisplay && allAddressesSelection) {
                            // Find which address was selected
                            const selectedAddressId = this.value;
                            const selectedAddress = document.querySelector(`[data-address-id="${selectedAddressId}"]`);
                            
                            // If default address is selected, show default display
                            const defaultRadio = defaultAddressDisplay.querySelector('.address-radio');
                            if (defaultRadio && defaultRadio.value === selectedAddressId) {
                                defaultAddressDisplay.style.display = 'block';
                                allAddressesSelection.style.display = 'none';
                            } else {
                                // Otherwise keep showing all addresses
                                defaultAddressDisplay.style.display = 'none';
                                allAddressesSelection.style.display = 'block';
                            }
                        }
                        
                        // Make form fields not required
                        const streetAddress = document.getElementById('street_address');
                        const city = document.getElementById('city');
                        const postalCode = document.getElementById('postal_code');
                        const country = document.getElementById('country');
                        const phone = document.getElementById('phone');
                        
                        if (streetAddress) streetAddress.required = false;
                        if (city) city.required = false;
                        if (postalCode) postalCode.required = false;
                        if (country) country.required = false;
                        if (phone) phone.required = true;
                    }
                });
            });

            // Handle "Use a new address" button click
            const useNewAddressBtn = document.getElementById('useNewAddressBtn');
            if (useNewAddressBtn) {
                useNewAddressBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Use new address button clicked');
                    if (typeof showNewAddressForm === 'function') {
                        showNewAddressForm();
                    } else if (window.showNewAddressForm) {
                        window.showNewAddressForm();
                    }
                });
            }

            // Modal elements
            const confirmModal = document.getElementById('confirmModal');
            const modalContent = document.getElementById('modalContent');
            const cancelButton = document.getElementById('cancelButton');
            const confirmButton = document.getElementById('confirmButton');
            const checkoutForm = document.getElementById('checkoutForm');
            const submitButton = document.getElementById('submitButton');
            const buttonText = document.getElementById('buttonText');
            const orderSummary = document.getElementById('orderSummary');
            const selectedPaymentMethodSpan = document.getElementById('selectedPaymentMethod');

            // Update payment method display in modal
            const paymentRadios = document.querySelectorAll('.payment-radio');
            paymentRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const paymentLabels = {
                        'credit_card': 'Credit/Debit Card',
                        'paypal': 'PayPal',
                        'bank_transfer': 'Bank Transfer'
                    };
                    selectedPaymentMethodSpan.textContent = paymentLabels[this.value] || this.value;
                });
            });

            // Form validation function
            function validateForm() {
                // Check if a saved address is selected (either from default display or all addresses)
                const selectedAddressRadio = document.querySelector('.address-radio:checked');
                
                // Check if new address form is visible
                const addressFormSection = document.getElementById('addressFormSection');
                const isNewAddressFormVisible = addressFormSection && addressFormSection.style.display !== 'none';
                
                if (!selectedAddressRadio && isNewAddressFormVisible) {
                    // Validate new address form
                    const streetAddress = document.getElementById('street_address').value.trim();
                    const city = document.getElementById('city').value.trim();
                    const postalCode = document.getElementById('postal_code').value.trim();
                    const country = document.getElementById('country').value;
                    const phone = document.getElementById('phone').value.trim();
                    
                    if (!streetAddress || !city || !postalCode || !country || !phone) {
                        if (window.toast && window.toast.error) {
                            window.toast.error('Please select a saved address or fill in all required shipping address fields.');
                        } else if (typeof showToast === 'function') {
                            showToast('Please select a saved address or fill in all required shipping address fields.', 'error');
                        } else {
                            alert('Please select a saved address or fill in all required shipping address fields.');
                        }
                        return false;
                    }
                } else if (!selectedAddressRadio && !isNewAddressFormVisible) {
                    // No address selected and form is hidden - this shouldn't happen but handle it
                    if (window.toast && window.toast.error) {
                        window.toast.error('Please select a shipping address.');
                    }
                    return false;
                }

                // Validate billing address if not same as shipping
                if (!sameAsShippingCheckbox.checked) {
                    const billingStreet = document.getElementById('billing_street').value.trim();
                    const billingCity = document.getElementById('billing_city').value.trim();
                    const billingPostal = document.getElementById('billing_postal').value.trim();
                    const billingCountry = document.getElementById('billing_country').value;
                    
                    if (!billingStreet || !billingCity || !billingPostal || !billingCountry) {
                        if (window.toast && window.toast.error) {
                            window.toast.error('Please fill in all billing address fields.');
                        } else if (typeof showToast === 'function') {
                            showToast('Please fill in all billing address fields.', 'error');
                        } else {
                            alert('Please fill in all billing address fields.');
                        }
                        return false;
                    }
                }

                return true;
            }

            // Show modal function
            function showModal() {
                if (!validateForm()) {
                    return false;
                }

                // Smoothly scale down order summary
                if (orderSummary) {
                    orderSummary.classList.add('summary-compact');
                }
                
                // Show modal with animation
                setTimeout(() => {
                    confirmModal.classList.add('modal-show');
                    setTimeout(() => {
                        if (typeof lucide !== 'undefined') {
                            lucide.createIcons();
                        }
                    }, 100);
                }, 300);
            }

            // Hide modal function
            function hideModal() {
                modalContent.style.animation = 'none';
                confirmModal.classList.remove('modal-show');
                
                // Scale back order summary
                setTimeout(() => {
                    if (orderSummary) {
                        orderSummary.classList.remove('summary-compact');
                    }
                }, 300);
            }

            // Submit button click - show modal
            if (submitButton) {
                submitButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    showModal();
                });
            }

            // Cancel button - hide modal
            if (cancelButton) {
                cancelButton.addEventListener('click', hideModal);
            }

            // Click outside modal to close
            if (confirmModal) {
                confirmModal.addEventListener('click', function(e) {
                    if (e.target === confirmModal) {
                        hideModal();
                    }
                });
            }

            // Confirm button - submit form
            if (confirmButton && checkoutForm) {
                confirmButton.addEventListener('click', function() {
                    console.log('Confirm button clicked - preparing to submit form');
                    
                    // Check if a saved address is selected
                    const selectedAddressRadio = document.querySelector('.address-radio:checked');
                    let shippingAddress = '';
                    
                    if (selectedAddressRadio) {
                        // Use saved address
                        const addressId = selectedAddressRadio.value;
                        // Get address data from the selected address card (could be in default display or all addresses)
                        const addressCard = selectedAddressRadio.closest('.address-option') || selectedAddressRadio.closest('#defaultAddressDisplay');
                        let addressLines = [];
                        
                        if (addressCard) {
                            const addressTextDivs = addressCard.querySelectorAll('.text-sm.text-gray-700 > div');
                            if (addressTextDivs.length > 0) {
                                addressLines = Array.from(addressTextDivs).map(div => div.textContent.trim());
                            }
                        }
                        
                        if (addressLines.length > 0) {
                            shippingAddress = addressLines.join('\n');
                        }
                        
                        // Add phone from form (if provided)
                        const phone = document.getElementById('phone').value.trim();
                        if (phone) {
                            shippingAddress += `\nPhone: ${phone}`;
                        }
                    } else {
                        // Use new address form
                        const streetAddress = document.getElementById('street_address').value.trim();
                        const city = document.getElementById('city').value.trim();
                        const postalCode = document.getElementById('postal_code').value.trim();
                        const country = document.getElementById('country').value;
                        const phone = document.getElementById('phone').value.trim();
                        
                        shippingAddress = `${streetAddress}\n${city}, ${postalCode}\n${country}\nPhone: ${phone}`;
                    }
                    
                    const deliveryNotes = document.getElementById('delivery_notes').value.trim();
                    if (deliveryNotes) {
                        shippingAddress += `\nNotes: ${deliveryNotes}`;
                    }
                    
                    console.log('Shipping address:', shippingAddress);
                    
                    // Create hidden input for combined shipping address
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'shipping_address';
                    hiddenInput.value = shippingAddress;
                    checkoutForm.appendChild(hiddenInput);
                    
                    // Handle billing address
                    if (!sameAsShippingCheckbox.checked) {
                        const billingStreet = document.getElementById('billing_street').value.trim();
                        const billingCity = document.getElementById('billing_city').value.trim();
                        const billingPostal = document.getElementById('billing_postal').value.trim();
                        const billingCountry = document.getElementById('billing_country').value;
                        
                        if (billingStreet && billingCity && billingPostal && billingCountry) {
                            const billingAddress = `${billingStreet}\n${billingCity}, ${billingPostal}\n${billingCountry}`;
                            const billingInput = document.createElement('input');
                            billingInput.type = 'hidden';
                            billingInput.name = 'billing_address';
                            billingInput.value = billingAddress;
                            checkoutForm.appendChild(billingInput);
                            console.log('Billing address:', billingAddress);
                        }
                    }

                    // Show loading state
                    confirmButton.disabled = true;
                    confirmButton.innerHTML = '<i data-lucide="loader" class="w-4 h-4 animate-spin"></i> Processing...';
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }

                    console.log('Submitting form...');
                    // Submit form
                    checkoutForm.submit();
                });
            }
        });
        </script>
    </div>
</div>
{% endblock %}