{% extends 'base.html' %}
{% load static %}

{% block title %}Order #{{ order.order_number }} - AuroraMart{% endblock %}

{% block content %}
<div class="bg-gray-50 min-h-screen py-8">
    <div class="container mx-auto px-4">
        <!-- Cancel Order Confirmation Modal -->
        {% if order.status == 'pending' %}
        <div id="cancelOrderModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 backdrop-blur-sm">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 transform transition-all scale-95 opacity-0" id="cancelModalContent">
                <div class="p-6">
                    <div class="flex items-center justify-center w-16 h-16 mx-auto bg-red-100 rounded-full mb-4">
                        <i data-lucide="alert-triangle" class="w-8 h-8 text-red-600"></i>
                    </div>
                    <h3 class="text-xl font-bold text-center text-gray-900 mb-2">Cancel Order</h3>
                    <p class="text-center text-gray-600 mb-6">Are you sure you want to cancel this order?</p>
                    
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <div class="flex justify-between text-sm mb-2">
                            <span class="text-gray-600">Order Number:</span>
                            <span class="font-bold text-gray-900">{{ order.order_number }}</span>
                        </div>
                        <div class="flex justify-between text-sm mb-2">
                            <span class="text-gray-600">Order Total:</span>
                            <span class="font-bold text-gray-900">${{ order.total|floatformat:2 }}</span>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500">
                            <span>Status:</span>
                            <span class="capitalize">{{ order.status }}</span>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-6">
                        <p class="text-xs text-yellow-800 flex items-center">
                            <i data-lucide="info" class="w-4 h-4 mr-2 flex-shrink-0"></i>
                            This action cannot be undone. The order will be cancelled and stock will be restored.
                        </p>
                    </div>
                    
                    <form method="post" action="{% url 'orders:cancel_order' order.id %}" id="cancelOrderForm">
                        {% csrf_token %}
                        <div class="flex gap-3">
                            <button type="button" 
                                    id="cancelModalButton"
                                    class="flex-1 px-4 py-3 border border-gray-300 rounded-lg text-gray-700 font-semibold hover:bg-gray-50 transition">
                                Keep Order
                            </button>
                            <button type="submit" 
                                    id="confirmCancelButton"
                                    class="flex-1 px-4 py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition flex items-center justify-center gap-2">
                                <i data-lucide="x-circle" class="w-4 h-4"></i>
                                Cancel Order
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Back Button -->
        <div class="mb-6">
            <a href="{% url 'orders:order_list' %}" 
               class="inline-flex items-center text-blue-600 hover:text-blue-700 font-medium transition">
                <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>
                Back to Orders
            </a>
        </div>

        <!-- Order Status Progress -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8 mb-6">
            <div class="flex items-center justify-between max-w-4xl mx-auto">
                <!-- Pending -->
                <div class="flex flex-col items-center flex-1">
                    <div class="rounded-full h-12 w-12 flex items-center justify-center mb-2 transition-all
                                {% if order.status == 'pending' %}bg-yellow-500 text-white ring-4 ring-yellow-200
                                {% elif order.status == 'processing' or order.status == 'shipped' or order.status == 'delivered' %}bg-green-500 text-white
                                {% else %}bg-gray-200 text-gray-400{% endif %}">
                        {% if order.status == 'pending' or order.status == 'processing' or order.status == 'shipped' or order.status == 'delivered' %}
                            <i data-lucide="check" class="w-6 h-6"></i>
                        {% else %}
                            <i data-lucide="clock" class="w-6 h-6"></i>
                        {% endif %}
                    </div>
                    <span class="text-sm font-semibold {% if order.status == 'pending' %}text-yellow-600{% else %}text-gray-600{% endif %}">
                        Pending
                    </span>
                </div>

                <!-- Connector Line 1 -->
                <div class="flex-1 h-1 mx-2 rounded
                            {% if order.status == 'processing' or order.status == 'shipped' or order.status == 'delivered' %}bg-green-500
                            {% else %}bg-gray-200{% endif %}"></div>

                <!-- Processing -->
                <div class="flex flex-col items-center flex-1">
                    <div class="rounded-full h-12 w-12 flex items-center justify-center mb-2 transition-all
                                {% if order.status == 'processing' %}bg-blue-500 text-white ring-4 ring-blue-200
                                {% elif order.status == 'shipped' or order.status == 'delivered' %}bg-green-500 text-white
                                {% else %}bg-gray-200 text-gray-400{% endif %}">
                        {% if order.status == 'shipped' or order.status == 'delivered' %}
                            <i data-lucide="check" class="w-6 h-6"></i>
                        {% else %}
                            <i data-lucide="cog" class="w-6 h-6 {% if order.status == 'processing' %}animate-spin{% endif %}"></i>
                        {% endif %}
                    </div>
                    <span class="text-sm font-semibold {% if order.status == 'processing' %}text-blue-600{% else %}text-gray-600{% endif %}">
                        Processing
                    </span>
                </div>

                <!-- Connector Line 2 -->
                <div class="flex-1 h-1 mx-2 rounded
                            {% if order.status == 'shipped' or order.status == 'delivered' %}bg-green-500
                            {% else %}bg-gray-200{% endif %}"></div>

                <!-- Shipped -->
                <div class="flex flex-col items-center flex-1">
                    <div class="rounded-full h-12 w-12 flex items-center justify-center mb-2 transition-all
                                {% if order.status == 'shipped' %}bg-purple-500 text-white ring-4 ring-purple-200
                                {% elif order.status == 'delivered' %}bg-green-500 text-white
                                {% else %}bg-gray-200 text-gray-400{% endif %}">
                        {% if order.status == 'delivered' %}
                            <i data-lucide="check" class="w-6 h-6"></i>
                        {% else %}
                            <i data-lucide="truck" class="w-6 h-6"></i>
                        {% endif %}
                    </div>
                    <span class="text-sm font-semibold {% if order.status == 'shipped' %}text-purple-600{% else %}text-gray-600{% endif %}">
                        Shipped
                    </span>
                </div>

                <!-- Connector Line 3 -->
                <div class="flex-1 h-1 mx-2 rounded
                            {% if order.status == 'delivered' %}bg-green-500
                            {% else %}bg-gray-200{% endif %}"></div>

                <!-- Delivered -->
                <div class="flex flex-col items-center flex-1">
                    <div class="rounded-full h-12 w-12 flex items-center justify-center mb-2 transition-all
                                {% if order.status == 'delivered' %}bg-green-500 text-white ring-4 ring-green-200
                                {% else %}bg-gray-200 text-gray-400{% endif %}">
                        <i data-lucide="check-circle" class="w-6 h-6"></i>
                    </div>
                    <span class="text-sm font-semibold {% if order.status == 'delivered' %}text-green-600{% else %}text-gray-600{% endif %}">
                        Delivered
                    </span>
                </div>
            </div>

            <!-- Cancelled Status (if applicable) -->
            {% if order.status == 'cancelled' %}
            <div class="mt-6 text-center">
                <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold bg-red-100 text-red-800">
                    <i data-lucide="x-circle" class="w-4 h-4 mr-2"></i>
                    This order has been cancelled
                </span>
            </div>
            {% endif %}
        </div>

        <!-- Order Header Card -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">
                        Order #{{ order.order_number }}
                    </h1>
                    <p class="text-gray-600 flex items-center gap-2">
                        <i data-lucide="calendar" class="w-4 h-4"></i>
                        Placed on {{ order.created_at|date:"F d, Y" }} at {{ order.created_at|time:"g:i A" }}
                    </p>
                </div>
                <div class="mt-4 md:mt-0">
                    {% if order.status == 'pending' %}
                        <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold bg-yellow-100 text-yellow-800 shadow-sm">
                            <i data-lucide="clock" class="w-4 h-4 mr-2"></i>
                            Pending
                        </span>
                    {% elif order.status == 'processing' %}
                        <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold bg-blue-100 text-blue-800 shadow-sm">
                            <i data-lucide="cog" class="w-4 h-4 mr-2 animate-spin"></i>
                            Processing
                        </span>
                    {% elif order.status == 'shipped' %}
                        <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold bg-purple-100 text-purple-800 shadow-sm">
                            <i data-lucide="truck" class="w-4 h-4 mr-2"></i>
                            Shipped
                        </span>
                    {% elif order.status == 'delivered' %}
                        <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold bg-green-100 text-green-800 shadow-sm">
                            <i data-lucide="check-circle" class="w-4 h-4 mr-2"></i>
                            Delivered
                        </span>
                    {% elif order.status == 'cancelled' %}
                        <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold bg-red-100 text-red-800 shadow-sm">
                            <i data-lucide="x-circle" class="w-4 h-4 mr-2"></i>
                            Cancelled
                        </span>
                    {% endif %}
                </div>
            </div>

            <!-- Status Description -->
            <div class="bg-blue-50 rounded-lg p-4 border border-blue-100">
                <p class="text-sm text-blue-800 flex items-center">
                    <i data-lucide="info" class="w-4 h-4 mr-2 flex-shrink-0"></i>
                    {% if order.status == 'pending' %}
                        Your order has been received and is awaiting processing.
                    {% elif order.status == 'processing' %}
                        Your order is being prepared for shipment.
                    {% elif order.status == 'shipped' %}
                        Your order is on its way! Expected delivery soon.
                    {% elif order.status == 'delivered' %}
                        Your order has been delivered successfully.
                    {% elif order.status == 'cancelled' %}
                        This order has been cancelled.
                    {% endif %}
                </p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column - Order Items (2 columns) -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- Order Items -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                        <i data-lucide="package" class="w-5 h-5 mr-2 text-blue-600"></i>
                        Order Items
                    </h2>
                    
                    <div class="space-y-4">
                        {% for item in order.items.all %}
                        <div class="flex gap-4 pb-4 border-b border-gray-200 last:border-0">
                            <!-- Product Image -->
                            <div class="w-20 h-20 bg-gray-50 rounded-lg flex items-center justify-center flex-shrink-0 border border-gray-100">
                                {% if item.product.images.first %}
                                <img src="{{ item.product.images.first.image.url }}" 
                                     alt="{{ item.product.name }}"
                                     class="max-h-full max-w-full object-contain">
                                {% else %}
                                <i data-lucide="image" class="w-12 h-12 text-gray-400"></i>
                                {% endif %}
                            </div>
                            
                            <!-- Product Info -->
                            <div class="flex-1 min-w-0">
                                <h3 class="font-semibold text-base mb-1">
                                    <a href="{% url 'products:product_detail' item.product.sku %}" 
                                       class="hover:text-blue-600 transition">
                                        {{ item.product.name }}
                                    </a>
                                </h3>
                                <p class="text-gray-500 text-xs mb-2">{{ item.product.category.name }}</p>
                                
                                <!-- Variant Info -->
                                {% if item.product_variant %}
                                    {% if item.product_variant.color or item.product_variant.size %}
                                    <div class="flex gap-2 text-xs mb-3">
                                        {% if item.product_variant.color %}
                                        <span class="bg-gray-100 px-2 py-1 rounded-md text-gray-700">
                                            {{ item.product_variant.color }}
                                        </span>
                                        {% endif %}
                                        {% if item.product_variant.size %}
                                        <span class="bg-gray-100 px-2 py-1 rounded-md text-gray-700">
                                            Size: {{ item.product_variant.size }}
                                        </span>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                {% endif %}
                                
                                <div class="flex items-center gap-4">
                                    <p class="text-lg font-bold text-gray-900">${{ item.price|floatformat:2 }}</p>
                                    <p class="text-sm text-gray-600">Qty: {{ item.quantity }}</p>
                                </div>
                            </div>

                            <!-- Item Total -->
                            <div class="text-right flex items-start">
                                {% widthratio item.price 1 item.quantity as item_total %}
                                <p class="text-xl font-bold text-gray-900">${{ item_total|floatformat:2 }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Delivery Address -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                        <i data-lucide="map-pin" class="w-5 h-5 mr-2 text-blue-600"></i>
                        Delivery Information
                    </h2>
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-100">
                        <div class="text-sm text-gray-700 whitespace-pre-wrap">{{ order.delivery_address }}</div>
                        {% if order.contact_number %}
                        <div class="mt-3 pt-3 border-t border-gray-200 flex items-center text-sm text-gray-700">
                            <i data-lucide="phone" class="w-4 h-4 mr-2 text-blue-600"></i>
                            <span class="font-medium">{{ order.contact_number }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Right Column - Order Summary -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 sticky top-24">
                    <h2 class="text-xl font-bold mb-6 text-gray-900">Order Summary</h2>

                    <!-- Price Breakdown -->
                    <div class="space-y-3 mb-6 pb-6 border-b border-gray-200">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Subtotal</span>
                            <span class="font-semibold text-gray-900">${{ order.subtotal|floatformat:2 }}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Tax (10%)</span>
                            <span class="font-semibold text-gray-900">${{ order.tax|floatformat:2 }}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Shipping</span>
                            <span class="font-semibold text-gray-900">${{ order.shipping_cost|floatformat:2 }}</span>
                        </div>
                    </div>

                    <!-- Total -->
                    <div class="flex justify-between text-lg mb-6">
                        <span class="font-bold text-gray-900">Total</span>
                        <span class="font-bold text-gray-900">${{ order.total|floatformat:2 }}</span>
                    </div>

                    <!-- Payment Information -->
                    <div class="mb-6 pb-6 border-b border-gray-200">
                        <h3 class="font-semibold text-gray-900 mb-3 flex items-center">
                            <i data-lucide="credit-card" class="w-4 h-4 mr-2"></i>
                            Payment Details
                        </h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Method</span>
                                <span class="text-gray-900 capitalize">{{ order.payment_method|title }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Status</span>
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                                             {% if order.payment_status == 'completed' %}bg-green-100 text-green-800
                                             {% elif order.payment_status == 'pending' %}bg-yellow-100 text-yellow-800
                                             {% elif order.payment_status == 'failed' %}bg-red-100 text-red-800
                                             {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ order.payment_status|title }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="space-y-3">
                        {% if order.status == 'pending' %}
                        <button type="button" id="cancelOrderButton"
                                class="w-full bg-red-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-red-700 transition flex items-center justify-center shadow-sm">
                            <i data-lucide="x-circle" class="w-4 h-4 mr-2"></i>
                            Cancel Order
                        </button>
                        {% elif order.status == 'processing' or order.status == 'shipped' or order.status == 'delivered' %}
                        <button type="button" disabled
                                class="w-full bg-gray-300 text-gray-500 py-3 px-6 rounded-lg font-semibold cursor-not-allowed flex items-center justify-center shadow-sm">
                            <i data-lucide="x-circle" class="w-4 h-4 mr-2"></i>
                            Cannot Cancel ({{ order.status|title }})
                        </button>
                        {% endif %}
                        
                        <button onclick="window.print()"
                                class="w-full bg-white border border-gray-300 text-gray-700 py-3 px-6 rounded-lg font-semibold hover:bg-gray-50 transition flex items-center justify-center">
                            <i data-lucide="printer" class="w-4 h-4 mr-2"></i>
                            Print Order
                        </button>
                    </div>

                    <!-- Security Badge -->
                    <div class="flex items-center justify-center gap-2 text-xs text-gray-500 mt-6">
                        <i data-lucide="shield-check" class="w-4 h-4"></i>
                        <span>Secure Order</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ML-Powered Recommendations: People Also Bought -->
        <div class="mt-12 hidden" id="order-recommendations-section">
            <div class="flex items-center gap-2 mb-6">
                <h2 class="text-2xl font-bold text-gray-900">People Also Bought</h2>
            </div>
            
            <!-- Loading State -->
            <div id="order-recommendations-loading" class="flex items-center justify-center py-12 bg-white rounded-xl border border-gray-200">
                <div class="text-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-3"></div>
                    <p class="text-gray-600">Finding perfect recommendations for you...</p>
                </div>
            </div>
            
            <!-- Content State -->
            <div id="order-recommendations-content" class="hidden">
                <div id="order-recommendations-grid" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-6"></div>
            </div>
            
            <!-- Empty State -->
            <div id="order-recommendations-empty" class="hidden text-center py-12 bg-white rounded-xl border border-gray-200">
                <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="inbox" class="w-10 h-10 text-gray-400"></i>
                </div>
                <p class="text-gray-600">No recommendations available at the moment</p>
            </div>
        </div>
    </div>
</div>

<script>
console.log('Order detail page script loading...');
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoaded fired - initializing order detail page');
    
    // Initialize Lucide icons
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }

    // Cancel Order Modal Functionality
    const orderStatus = '{{ order.status }}';
    if (orderStatus === 'pending') {
        const cancelOrderButton = document.getElementById('cancelOrderButton');
        const cancelOrderModal = document.getElementById('cancelOrderModal');
        const cancelModalContent = document.getElementById('cancelModalContent');
        const cancelModalButton = document.getElementById('cancelModalButton');
        const confirmCancelButton = document.getElementById('confirmCancelButton');
        const cancelOrderForm = document.getElementById('cancelOrderForm');

        // Show modal function
        function showCancelModal() {
            cancelOrderModal.classList.add('flex');
            cancelOrderModal.classList.remove('hidden');
            setTimeout(() => {
                cancelModalContent.style.transform = 'scale(1)';
                cancelModalContent.style.opacity = '1';
            }, 10);
        }

        // Hide modal function
        function hideCancelModal() {
            cancelModalContent.style.transform = 'scale(0.95)';
            cancelModalContent.style.opacity = '0';
            setTimeout(() => {
                cancelOrderModal.classList.remove('flex');
                cancelOrderModal.classList.add('hidden');
            }, 300);
        }

        // Show modal when cancel button is clicked
        if (cancelOrderButton) {
            cancelOrderButton.addEventListener('click', function(e) {
                e.preventDefault();
                showCancelModal();
            });
        }

        // Hide modal when cancel button in modal is clicked
        if (cancelModalButton) {
            cancelModalButton.addEventListener('click', hideCancelModal);
        }

        // Click outside modal to close
        if (cancelOrderModal) {
            cancelOrderModal.addEventListener('click', function(e) {
                if (e.target === cancelOrderModal) {
                    hideCancelModal();
                }
            });
        }

        // Handle form submission
        if (cancelOrderForm) {
            cancelOrderForm.addEventListener('submit', function(e) {
                // Show loading state
                if (confirmCancelButton) {
                    confirmCancelButton.disabled = true;
                    confirmCancelButton.innerHTML = '<i data-lucide="loader" class="w-4 h-4 animate-spin"></i> Cancelling...';
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                }
            });
        }
    }

    // ML-Powered Order Recommendations
    // Fetch order-based recommendations
    console.log('=== FETCHING ORDER RECOMMENDATIONS ===');
    console.log('Order ID: {{ order.id }}');
    console.log('URL: /api/recommendations/order-recommendations/{{ order.id }}/');
    
    fetch('/api/recommendations/order-recommendations/{{ order.id }}/', {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
        },
        credentials: 'include'  // Changed from 'same-origin' to 'include' to ensure cookies are sent
    })
    .then(response => {
        console.log('Response received. Status:', response.status, response.statusText);
        console.log('Response headers:', response.headers);
        
        if (!response.ok) {
            // Try to get error message from response
            return response.json().then(err => {
                console.error('API Error Response:', err);
                throw new Error(`HTTP ${response.status}: ${err.error || err.detail || response.statusText}`);
            }).catch(() => {
                throw new Error(`HTTP error! status: ${response.status}`);
            });
        }
        return response.json();
    })
    .then(data => {
        console.log('Order recommendations response:', data);
        console.log('Number of recommendations:', data.recommendations ? data.recommendations.length : 0);
        
        const loadingState = document.getElementById('order-recommendations-loading');
        const contentState = document.getElementById('order-recommendations-content');
        const emptyState = document.getElementById('order-recommendations-empty');
        
        if (loadingState) loadingState.classList.add('hidden');
        
        if (data.recommendations && data.recommendations.length > 0) {
            console.log('Showing recommendations');
            document.getElementById('order-recommendations-section').classList.remove('hidden');
            if (contentState) contentState.classList.remove('hidden');
            const grid = document.getElementById('order-recommendations-grid');
            
            if (grid) {
                grid.innerHTML = ''; // Clear existing content
                data.recommendations.forEach(product => {
                    grid.innerHTML += createOrderRecommendationCard(product);
                });
                
                // Reinitialize Lucide icons
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }
        } else {
            console.log('No recommendations found, hiding section');
            document.getElementById('order-recommendations-section').classList.add('hidden');
        }
    })
    .catch(error => {
        console.error('=== ERROR LOADING RECOMMENDATIONS ===');
        console.error('Error details:', error);
        console.error('Error message:', error.message);
        console.error('Error stack:', error.stack);
        
        const loadingState = document.getElementById('order-recommendations-loading');
        if (loadingState) loadingState.classList.add('hidden');
        document.getElementById('order-recommendations-section').classList.add('hidden');
    });

    function createOrderRecommendationCard(product) {
        const lowestVariant = product.lowest_variant || {};
        const primaryImage = product.primary_image;
        // Handle primary_image as object with url property or as string
        const imageUrl = primaryImage && typeof primaryImage === 'object' ? primaryImage.url : primaryImage;
        const price = lowestVariant.price || '0.00';
        const comparePrice = lowestVariant.compare_price;
        const hasDiscount = comparePrice && parseFloat(comparePrice) > parseFloat(price);
        const discountPercent = hasDiscount ? Math.round(((parseFloat(comparePrice) - parseFloat(price)) / parseFloat(comparePrice)) * 100) : 0;
        const stock = lowestVariant.stock || 0;
        const variantId = lowestVariant.id;

        return `
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden hover:shadow-xl transition duration-300 flex flex-col group">
                <div class="relative overflow-hidden">
                    ${imageUrl ? 
                        `<img src="${imageUrl}" alt="${product.name}" class="w-full h-48 object-cover group-hover:scale-110 transition duration-500">` :
                        `<div class="w-full h-48 bg-gray-100 flex items-center justify-center">
                            <i data-lucide="image" class="w-16 h-16 text-gray-400"></i>
                        </div>`
                    }
                    ${hasDiscount ? `
                        <div class="absolute top-2 left-2 bg-red-500 text-white text-xs px-2 py-1 rounded-full font-bold">
                            -${discountPercent}%
                        </div>
                    ` : ''}
                    ${stock > 0 && stock < 10 ? `
                        <div class="absolute top-2 right-2 bg-orange-500 text-white text-xs px-2 py-1 rounded-full font-semibold">
                            Only ${stock} left
                        </div>
                    ` : stock === 0 ? `
                        <div class="absolute top-2 right-2 bg-red-500 text-white text-xs px-2 py-1 rounded-full font-semibold">
                            Out of Stock
                        </div>
                    ` : ''}
                </div>
                
                <div class="p-4 flex-1 flex flex-col">
                    <a href="/products/${product.sku}/" class="hover:text-blue-600 transition">
                        <h3 class="font-semibold text-sm mb-2 line-clamp-2 min-h-[2.5rem]">${product.name}</h3>
                    </a>
                    
                    ${product.brand ? `<p class="text-xs text-gray-500 mb-2">${product.brand}</p>` : ''}
                    
                    <div class="flex items-center mb-3">
                        <div class="flex text-yellow-400 text-xs">
                            ${'★'.repeat(Math.floor(product.rating || 0))}${'☆'.repeat(5 - Math.floor(product.rating || 0))}
                        </div>
                        <span class="text-xs text-gray-600 ml-1">(${product.review_count || 0})</span>
                    </div>
                    
                    <div class="mt-auto">
                        <div class="flex items-baseline gap-2 mb-3">
                            <span class="text-lg font-bold text-blue-600">$${parseFloat(price).toFixed(2)}</span>
                            ${hasDiscount ? 
                                `<span class="text-xs text-gray-400 line-through">$${parseFloat(comparePrice).toFixed(2)}</span>` : ''
                            }
                        </div>
                        
                        ${stock > 0 && variantId ? `
                            <button onclick="quickAddToCartFromOrder(${product.id}, ${variantId}, '${product.name.replace(/'/g, "\\'")}')" 
                                    class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition flex items-center justify-center gap-2 text-sm">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                                Add to Cart
                            </button>
                        ` : `
                            <button disabled class="w-full bg-gray-300 text-gray-500 px-4 py-2 rounded-lg font-semibold cursor-not-allowed text-sm">
                                Out of Stock
                            </button>
                        `}
                    </div>
                </div>
            </div>
        `;
    }

    // Quick Add to Cart function for order recommendations
    window.quickAddToCartFromOrder = function(productId, variantId, productName) {
        const formData = new FormData();
        formData.append('variant_id', variantId);
        formData.append('quantity', 1);

        fetch(`/cart/add/${productId}/`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showOrderToast(`${productName} added to cart!`, 'success');
                
                // Update cart count if CartModule exists
                if (typeof CartModule !== 'undefined') {
                    CartModule.updateCartCount();
                }
            } else {
                showOrderToast(data.message || 'Unable to add to cart', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showOrderToast('An error occurred. Please try again.', 'error');
        });
    };

    // Toast notification helper
    function showOrderToast(message, type = 'success') {
        const toast = document.createElement('div');
        const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
        const icon = type === 'success' ? 'check-circle' : 'x-circle';
        
        toast.className = `fixed bottom-4 right-4 px-6 py-4 rounded-lg shadow-lg text-white z-50 flex items-center gap-3 ${bgColor} animate-slide-in`;
        toast.innerHTML = `
            <i data-lucide="${icon}" class="w-5 h-5"></i>
            <span>${message}</span>
        `;
        document.body.appendChild(toast);
        
        // Initialize icon
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
        
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(100%)';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
});

</script>

<style>
@keyframes slide-in {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes modalSlideIn {
    from {
        transform: scale(0.95) translateY(-20px);
        opacity: 0;
    }
    to {
        transform: scale(1) translateY(0);
        opacity: 1;
    }
}

.animate-slide-in {
    animation: slide-in 0.3s ease-out;
    transition: all 0.3s ease-out;
}

#cancelModalContent {
    transition: all 0.3s ease-out;
}

#cancelOrderModal.flex #cancelModalContent {
    animation: modalSlideIn 0.3s ease-out forwards;
}

@media print {
    .no-print, button, a {
        display: none !important;
    }
}
</style>
{% endblock %}
